<div class="container py-4" [attr.dir]="isArabic ? 'rtl' : 'ltr'">
  <div class="dashboard-header" [class.align-right]="isArabic">
    <h1>{{ isArabic ? 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·Ø¹Ù…' : 'Restaurant Dashboard' }}</h1>
    <p>{{ isArabic ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ' : 'Manage tables and orders in real time' }}</p>
  </div>
  <div class="d-flex justify-content-center my-3">
    <button
      class="btn"
      [class.btn-primary]="!todayHistoryExists"
      [class.btn-danger]="todayHistoryExists"
      (click)="handleDailyRecord()"
      [disabled]="isCreatingHistory"
      >
      {{ todayHistoryExists
      ? (isArabic ? 'ğŸ”´ Ø¥ØºÙ„Ø§Ù‚ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…' : 'ğŸ”´ Close Daily Record')
      : (isArabic ? 'ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'ğŸŸ¢ Create New Daily Record') }}
    </button>
  </div>
  <div class="row g-4">
    <!-- Tables List -->
    <div class="col-lg-4">
      <div class="card sticky-col" style="position: sticky; top: 16px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>{{ isArabic ? 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª' : 'Tables' }}</span>
          <span class="badge bg-primary">{{ tables.length || 0 }}</span>
        </div>
        <div class="p-3 border-bottom">
          <div class="d-flex gap-2">
            <input type="text"
              class="form-control"
              [placeholder]="isArabic ? 'Ø§Ø³Ù… Ø·Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'New table name'"
              [(ngModel)]="newTableName"
              (keyup.enter)="addTable()">
              <button type="button"
                class="btn btn-primary"
                [disabled]="!(newTableName && newTableName.trim())"
                (click)="addTable()">
                {{ isArabic ? 'Ø¥Ø¶Ø§ÙØ© Ø·Ø§ÙˆÙ„Ø©' : 'Add Table' }}
              </button>
            </div>
          </div>
          <ul class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">
            @for (table of tables; track table) {
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
                (click)="selectTable(table)"
                [class.active]="selectedTable?.id === table.id">
                <div class="d-flex flex-column">
                  <span class="fw-semibold">{{ table.name || 'Table' }}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge" [ngClass]="table.availability ? 'bg-success' : 'bg-danger'">
                    {{ table.availability ? (isArabic ? 'Ù…ØªØ§Ø­' : 'Available') : (isArabic ? 'Ù…Ø´ØºÙˆÙ„Ø©' : 'Occupied') }}
                  </span>
                  <button class="btn btn-sm btn-outline-secondary"
                    (click)="$event.stopPropagation(); toggleAvailability(table)">
                    {{ isArabic ? 'ØªØ¨Ø¯ÙŠÙ„' : 'Toggle' }}
                  </button>
                </div>
              </li>
            }
          </ul>
        </div>
      </div>

      <!-- Orders Section -->
      @if (selectedTable) {
        <div class="col-lg-8">
          <div class="card orders-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                {{ isArabic ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù€' : 'Orders for' }} <strong>{{ selectedTable.name || (isArabic ? 'Ø·Ø§ÙˆÙ„Ø©' : 'Table') }}</strong>
              </div>
              <button class="btn btn-sm btn-outline-light" (click)="selectedTable = null">{{ isArabic ? 'Ø±Ø¬ÙˆØ¹' : 'Back' }}</button>
            </div>
            <div class="card-body">
              <ul class="list-group mb-3">
                @for (order of selectedTable.order | keyvalue; track order) {
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1 pe-3">
                        <div class="d-flex align-items-center gap-3">
                          <div class="order-title">{{ displayOrderName(order.value.name) }}</div>
                          <!-- âœ… Item state badge -->
                          <small>
                            <span class="badge clickable"
                        [ngClass]="{
                            'bg-info': order.value.state === 'ordered',
                           'bg-warning': order.value.state === 'ready',
                            'bg-success': order.value.state === 'done'
                               }"
                              (click)="markAsDone({ tableKey: selectedTable!.id, orderKey: order.key, order: order.value })"
                              >
                              {{ order.value.state || 'unknown' }}
                            </span>
                          </small>
                        </div>
                        <!-- Choices -->
                        @if (getChoiceDisplayList(order.value.name).length) {
                          <div class="choice-group mt-2">
                            @for (c of getChoiceDisplayStructured(order.value.name); track c; let i = $index) {
                              <span class="choice-chip"
                                [class.active]="getDraftChoiceIndex(order.key, order.value) === i"
                                (click)="setChoiceDraft(order.key, order.value, i)">{{ c.label }}@if (c.add) {
                                <span class="choice-add"> +â‚ª{{ c.add }}</span>
                              }</span>
                            }
                          </div>
                        }
                        <div class="mt-2">
                          <label class="small">{{ isArabic ? 'ØªÙØ§ØµÙŠÙ„' : 'Details' }}</label>
                          <input type="text" [(ngModel)]="order.value.details"
                            [placeholder]="isArabic ? 'Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Enter details'"
                            class="form-control form-control-sm">
                          </div>
                        </div>
                        <div class="text-end ms-3" style="min-width: 180px;">
                          <input type="number" [(ngModel)]="order.value.quantity" min="0"
                            class="form-control form-control-sm" />
                            <div class="d-flex gap-2 mt-2">
                              <button class="btn btn-sm btn-primary" style="flex: 1;"
                                (click)="updateOrder(order.key, order.value.quantity, order.value.details || '')">
                                {{ isArabic ? 'ØªØ­Ø¯ÙŠØ«' : 'Update' }}
                              </button>
                              <button class="btn btn-sm btn-warning" style="flex: 1;"
                                (click)="deleteOrder(order.key)">
                                {{ isArabic ? 'Ø­Ø°Ù' : 'Remove' }}
                              </button>
                            </div>
                          </div>
                        </div>
                      </li>
                    }
                  </ul>
                  <!-- Add New Order + Checkout -->
                  <div class="d-flex flex-wrap align-items-stretch gap-2 mb-3">
                    <div class="d-flex flex-wrap gap-2 flex-grow-1">
                      <input type="text" #itemName class="form-control"
                        [placeholder]="isArabic ? 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù' : 'Item name'"
                        style="max-width: 260px;" list="menuSuggestions">
                        <datalist id="menuSuggestions">
                          @for (name of menuItemNames; track name) {
                            <option [value]="name"></option>
                          }
                        </datalist>
                        <input type="number" #itemQty class="form-control"
                          [placeholder]="isArabic ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Qty'" min="1"
                          style="max-width: 120px;">
                          <input type="text" #itemDetails class="form-control"
                            [placeholder]="isArabic ? 'ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Details (optional)'">
                            <button class="btn btn-success"
                      (click)="addOrder(itemName.value, +itemQty.value, itemDetails.value);
                               itemName.value=''; itemQty.value=''; itemDetails.value=''">
                              {{ isArabic ? 'Ø¥Ø¶Ø§ÙØ©' : 'Add' }}
                            </button>
                          </div>
                          <div class="ms-auto d-flex align-items-center">
                            <button class="btn btn-outline-dangerbtn-sm btn-warning"
                              [disabled]="!hasOrders()"
                              (click)="checkoutSelectedTable()">
                              {{ isArabic ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'Checkout' }}
                            </button>
                          </div>
                        </div>
                        <!-- âœ… Total Price Display -->
                        <div class="text-end mt-3 border-top pt-2">
                          <strong>{{ isArabic ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:' : 'Total:' }}</strong>
                          <span class="fs-5 fw-bold text-primary">{{ getTotalPrice() | number:'1.2-2' }} â‚ª</span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
              <!-- ğŸ§¾ Receipt Modal -->
              @if (showReceiptModal) {
                <div
                  class="modal fade show d-block"
                  tabindex="-1"
                  role="dialog"
                  aria-modal="true"
                  [ngStyle]="{ background: 'rgba(0,0,0,0.5)' }">
                  <div class="modal-dialog modal-dialog-centered modal-md" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <div>
                          <h5 class="modal-title mb-0">{{ restaurantDisplayName }}</h5>
                          <small class="text-muted d-block">{{ isArabic ? 'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Receipt' }} â€” {{ selectedTable?.name }}</small>
                        </div>
                        <button type="button" class="btn-close" aria-label="Close" (click)="processCheckout('cancel')"></button>
                      </div>
                      <div class="modal-body">
                        <ul class="list-group mb-3">
                          @for (o of receiptOrders; track o) {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              <div class="me-3">
                                <div class="fw-semibold">{{ displayOrderName(o.name) }}</div>
                                <small class="text-muted">
                                  {{ isArabic ? 'Ø§Ù„Ø³Ø¹Ø±:' : 'Price:' }} {{ getOrderUnitPrice(o) | number:'1.2-2' }} â‚ª Ã— {{ o.quantity }}
                                </small>
                              </div>
                              <div class="text-end text-nowrap">
                                <div class="fw-semibold">{{ (getOrderUnitPrice(o) * o.quantity) | number:'1.2-2' }} â‚ª</div>
                              </div>
                            </li>
                          }
                        </ul>
                        <div class="d-flex justify-content-between border-top pt-2">
                          <strong>{{ isArabic ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:' : 'Total:' }}</strong>
                          <span class="fs-5 fw-bold text-primary">{{ receiptTotal | number:'1.2-2' }} â‚ª</span>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" (click)="processCheckout('cancel')">{{ isArabic ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}</button>
                        <button type="button" class="btn btn-primary" (click)="processCheckout('print')">ğŸ–¨ {{ isArabic ? 'Ø·Ø¨Ø§Ø¹Ø©' : 'Print' }}</button>
                        <button type="button" class="btn btn-success" (click)="processCheckout('done')">{{ isArabic ? 'ØªÙ…' : 'Done' }}</button>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
